CREATE EXTENSION IF NOT EXISTS pgcrypto;

DROP TABLE IF EXISTS article_comments;
DROP TABLE IF EXISTS comments;
DROP TABLE IF EXISTS articles;
DROP TABLE IF EXISTS categories;
DROP TABLE IF EXISTS users;

START TRANSACTION;

CREATE TABLE users (
  user_id INTEGER GENERATED BY DEFAULT AS IDENTITY (
    START
    WITH
      1001
  ) PRIMARY KEY,
  name VARCHAR(16) NOT NULL CHECK (LENGTH(name) >= 3),
  email VARCHAR(64) NOT NULL UNIQUE,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP(0)
);

CREATE TABLE categories (
  category_id INTEGER GENERATED BY DEFAULT AS IDENTITY (
    START
    WITH
      1001
  ) PRIMARY KEY,
  name VARCHAR(16) NOT NULL UNIQUE CHECK (LENGTH(name) >= 3),
);

CREATE TABLE articles (
  article_id INTEGER GENERATED BY DEFAULT AS IDENTITY (
    START
    WITH
      1001
  ) PRIMARY KEY,
  title VARCHAR(32) NOT NULL,
  content TEXT NOT NULL,
  user_id INTEGER NOT NULL REFERENCES users (user_id) ON DELETE CASCADE,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP(0),
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP(0) CHECK (created_at <= updated_at)
);

CREATE TABLE article_categories (
  article_id INTEGER REFERENCES articles (article_id) ON DELETE CASCADE,
  category_id INTEGER REFERENCES categories (category_id) ON DELETE CASCADE,
  PRIMARY KEY (article_id, category_id)
);

CREATE TABLE comments (
  comment_id INTEGER GENERATED BY DEFAULT AS IDENTITY (
    START
    WITH
      1001
  ) PRIMARY KEY,
  content TEXT NOT NULL,
  user_id INTEGER NOT NULL REFERENCES users (user_id) ON DELETE CASCADE,
  article_id INTEGER REFERENCES articles (article_id) ON DELETE SET NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP(0),
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP(0) CHECK (created_at <= updated_at)
);

-- 確認
SELECT * FROM users;
SELECT * FROM categories;
SELECT * FROM articles;
SELECT * FROM article_categories;
SELECT * FROM comments;

ROLLBACK;